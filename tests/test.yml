---

- hosts: all
  roles:
    - ../../
  vars:
    redis_requirepass: 'my_unsecure_password'
    redis_slaveof: '127.0.0.1:{{ redis_masterauth_masterport }}'
    redis_masterauth_masterip: '127.0.0.1'
    redis_masterauth_masterport: 7777

  post_tasks:
    - name: SET_FACT | Create vars
      set_fact:
        test_key: 'key_{{ 10000 | random }}'
        test_val: 'value_{{ 10000 | random }}'

    - name: SHELL | Start master Redis
      shell: redis-server --port {{ redis_masterauth_masterport }} &
      changed_when: false

    - name: COMMAND | Check Auth is running (and fails auth)
      command: redis-cli SET a 1
      register: f
      failed_when: f.stdout.find('Authentication required') == -1
      changed_when: false

    - name: COMMAND | Test SET on master
      command: redis-cli -p {{ redis_masterauth_masterport }} SET {{ test_key }} {{ test_val }}
      register: s
      failed_when: s.stdout.find('OK') == -1
      changed_when: false

    - name: PAUSE | 1 sec
      pause: seconds=1

    - name: COMMAND | Test GET on slave
      command: redis-cli -a {{ redis_requirepass }} GET {{ test_key }}
      register: g
      failed_when: g.stdout.find(test_val) == -1
      changed_when: false

    - name: SHELL | Kill master Redis
      shell: ps aux | grep -v awk | awk '/redis-server / && /{{ redis_masterauth_masterport }}/ { print $2 }' | xargs -n1 kill
      changed_when: false
